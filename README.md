# AHC030

$P((x, y), i) := $ $v(x, y) = i$ となる確率 とする
-> 座標に対して 0から20までのVec<f64>を持てばよい

占いで確定しているもの: i64 として持てばよい

これをベイズ推定でがんばる？


- 更新するとそれ以外のセルの更新が入る
  - 確定したときの更新

  - 推定したときの更新

...


- [ ] すべて確定させるやつを実装
- [ ] 色表示を実装、まだ見ていないやつを良しなにがんばる
  - 更新大変そう？うーん
- [ ] 推定する？

- ローカルのスコア 当てにならない(サイズ...)
  - なんかいい感じに調整しないとカス
- Rust サイコー！！
  - テストが途中で書ける


AtCoderにapprox入っていなくて切れた
https://atcoder.jp/contests/ahc030/submissions/50213595


1 が確定しているのに期待値がほぼ0になったりがある
- 確定を期待値の差が0.5を超えるときにはreupdateを掛けるように
  - もうこの時点でベイズ更新が破綻しているが...

```
python run.py 100
100/100
total: 27.774561082798808
max: (1.0, '0099')
ave: 0.2777456108279881
min: (0.024930747922437674, '0042')
```

小さいピースが比較的大きな盤面にあると、探すのがやばい！
- それを占い使って何とかしてねって言う問題なので、それはそう


reupdate と称して変なことをしているが、これまずそう
- 無くすと壊れる (1.0 になる) のは減る
- 壊れるケース
  - すべてがピンクになるケース
  - 推定できている(ちょうとピンクになっている) のにダメなケース
  - 推定に失敗し、honestyになるケース


### 1st submit 
9,147,000,000点 https://atcoder.jp/contests/ahc030/submissions/50213655
ランダム1点掘って推測 -> 答えが定まったらsubmit
```
50/50
total: 5800000000
max: (400000000, '0019')
ave: 116000000.0
min: (4000000, '0038')
```
TL 32msなので余裕

確率バグってる 既に検出済の期待値がおかしい
バグってすべてOPEN(つまり愚直)になっているのがある

Nが小さいほうがスコア出易い
-> スコアを $N^2$ で割る、これにより自明(すべてOpen) に対する割合が知れる

```
50/50
total: 26.047947400074754
max: (1.0, '0048')
ave: 0.5209589480014951
min: (0.029585798816568046, '0038')
```
スコアを割合にした 1.0が最大(すべてOpen)


### 2nd submit
4,807,000,000点 https://atcoder.jp/contests/ahc030/submissions/50220698
314th -> 66th
まだ何か壊れてる
```
50/50
total: 15.449720465990834
max: (1.0, '0019')
ave: 0.3089944093198167
min: (0.024930747922437674, '0042')
```

### 3rd submit
4,145,000,000点 https://atcoder.jp/contests/ahc030/submissions/50287604
151th -> 95th
```
500/500
total: 136.74577575940262
max: (1.0, '0466')
ave: 0.2734915515188052
min: (0.02040816326530612, '0432')
```
一度堀った個所をもう一度掘るみたいなズルをしていたがやめた
-> dp で掛けていくとき、それが極端に小さい値だと誤差がやばい　ある程度正規化しておくと若干改善された
- まだすべて掘ってしまうケースがある
  - 最悪、X%以上掘ったら違うことをする...みたいな方針はあり
  - それ以外ではいい感じかも

### 4th submit
3,798,000,000点 https://atcoder.jp/contests/ahc030/submissions/50396734
146th -> 111th
```
500/500
total: 124.65606119078123
max: (1.0, '0439')
ave: 0.24931212238156247
min: (0.018518518518518517, '0210')
```
- update_submit_failed みたいなごのごにょをやらない
- 同じ形の時にちゃんと考慮するように
  - とはいえ毎回sortするようになり、ヤバいかも　もうちょい工夫が必要かも

### 5th submit
3,844,000,000点 https://atcoder.jp/contests/ahc030/submissions/50397658
111th -> 111th
- 失敗したら毎回resetする、みたいなことをしていたが重くない？
  - resetを辞める
    - これだとスコアが落ちた...
  - 失敗したら失敗した箇所を再度excavateするように
    - 1.0 になるケースが減った
- TLが大幅に改善！
  - 118ms だいぶ余裕がある

```
500/500
total: 120.33891724722339
max: (1.0, '0413')
ave: 0.2406778344944468
min: (0.0221606648199446, '0042')
```

### 6th submit
3,060,019,051点 https://atcoder.jp/contests/ahc030/submissions/50398916
110th -> 61th
- 前処理で適当なブロックに分けてpredictする
- 手元 2.8secだとTLEして1.0になっているが、提出すると100ms程度なので大丈夫そう
```
500/500
total: 105.98888492432575
max: (1.01953125, '0423')
ave: 0.2119777698486515
min: (0.0105, '0068')
```


### 7th submit
2,952,071,640点
70th -> 58th
- 最後適当に期待値小さいのを推測するのをランダムでするように
- 分割を油田の大きさの平均値で変えるように
- 手元だとスコア下がっている気がするので、プレテスで揺れそう
- TLは余裕そう 完答しきれていそう
```
500/500
total: 106.67462558271079
max: (1.14630008984375, '0286')
ave: 0.21334925116542158
min: (0.012444444444444444, '0000')
```

out2
```
500/500
total: 106.36773063457282
max: (1.0962152216066483, '0138')
ave: 0.21273546126914564
min: (0.012444444444444444, '0000')
==========================
low  1: (0.012444444444444444, '0000')
low  2: (0.013119535714285714, '0145')
low  3: (0.0158882725, '0068')
low  4: (0.017802595567867036, '0042')
low  5: (0.020061728395061727, '0210')
low  6: (0.02225376171875, '0282')
low  7: (0.02257698347107438, '0349')
low  8: (0.0233882725, '0346')
low  9: (0.025777777777777778, '0263')
==========================
high 1: (1.0962152216066483, '0138')
high 2: (1.0751745866666667, '0427')
high 3: (1.0726592075, '0348')
high 4: (1.0511499, '0019')
high 5: (0.98214968359375, '0423')
high 6: (0.7712944642857142, '0118')
high 7: (0.6672285625, '0182')
high 8: (0.6076946885813149, '0215')
high 9: (0.5581968672839506, '0161')
```

### 8th submit

3052282017点 https://atcoder.jp/contests/ahc030/submissions/50419059
59th -> 71th
- next_predictを近いのをいい感じに選んでやる
  - 範囲が適当なのでよくないかも

- 7th submit と比べて値が変わっている(手元でも)
  - 最後いい感じにしているのは良いので、パラメータ？

- [ ] 7th と比較して改悪した点を直す
- [ ] パラメータ弄る

```
500/500
total: 109.00054519668242
max: (1.05516448046875, '0015')
ave: 0.21800109039336485
min: (0.012444444444444444, '0000')
```


### 9th submit
2,946,705,021点 https://atcoder.jp/contests/ahc030/submissions/50432174
75th -> 62th
- よくわからん

```
500/500
total: 105.11081439325605
max: (1.075466115, '0348')
ave: 0.2102216287865121
min: (0.012444444444444444, '0000')
```

### 10th submit

3,099,603,676点 https://atcoder.jp/contests/ahc030/submissions/50432650
61th -> 72th

- 0.65を軸に掘るマスを決める、0.02 より大きく1未満のものを掘る
  - これによりpredictは殆ど行われないが...？

```
500/500
total: 100.96965530275565
max: (1.0631799445983379, '0127')
ave: 0.20193931060551132
min: (0.012444444444444444, '0000')
```


### 11th submit
3,230,639,052点 https://atcoder.jp/contests/ahc030/submissions/50433080
74th -> 75th

- 最初のpredict 大雑把にしすぎない

```
500/500
total: 101.12753310348508
max: (1.218998324099723, '0127')
ave: 0.20225506620697015
min: (0.012444444444444444, '0000')
```

### 12th submit

2,940,590,834点
84th -> 76th

ローカル、TLEしててスコア比較できてなくない？

- Random で、一番確率が高いのをOpenを繰り返す
  - 掘ったのの総和が一致したらsubmit
  - random が random じゃなくなるが...
- ローカルのTLを60secにしても1ケースTLEしている AtCoder上でもTLEする？
```
500/500
total: 100.06812739564242
max: (1.0099205459183673, '0235')
ave: 0.20013625479128483
min: (0.012444444444444444, '0000')
```


### 13th submit
2,910,449,432点
77th -> 75th
- honesty 確率高いやつから空けて総和が全部一致したらsubmit
- そもそもAtCoder上でhonesty発生していなさそうではあるが

```
500/500
total: 99.72446099680297
max: (0.75687459, '0019')
ave: 0.19944892199360595
min: (0.012444444444444444, '0000')
```

### 14th submit
2936748765点
75th -> 84th
- ave 30以下でそこそこ小さくサンプリング
```
500/500
total: 99.41359008431415
max: (0.5782576627218935, '0404')
ave: 0.1988271801686283
min: (0.012444444444444444, '0000')
```
さすがにこれはローカルを信じてよさそう

### 15th submit
2,926,649,628点
86th -> 86th
```
500/500
total: 99.35755067988502
max: (0.5491586925, '0019')
ave: 0.19871510135977005
min: (0.012444444444444444, '0000')
``

---

油田 $i$ が $(dx, dy)$ にある確率を $P(i, dx, dy)$ と表す。

- つまり、任意の $i$ に対して、 $\sum_{dx \in X, dy \in Y} P(i, dx, dy) = 1$ である(ここで、$X, Y$ は可動範囲)
- 初期状態だと、$P(i, dx, dy) = \frac{1}{|X||Y|}$ みたいな値になる

これをベイズ更新することを考える。

- 掘るクエリ
  クエリ結果を $q$ とすると、

  $$
  P(i, dx, dy) \gets P(i, dx, dy | q) = \frac{P(i, dx, dy) P(q | i, dx, dy)}{P(q)}
  $$

  で更新する。
  ここで、尤度 $P(q | i, dx, dy)$ は、「ピース $i$ を $(dx, dy)$ に配置したときにクエリ結果 $q$ が返ってくる確率」である。

  $P(q)$ を求めるのは面倒だが、更新後に \sum_{dx \in X, dy \in Y} P(i, dx, dy) = 1$ になるように丸めれば良いため、問題にならない。

  以降、
  $$
  P(i, dx, dy) \gets P(i, dx, dy | q) = P(i, dx, dy) P(q | i, dx, dy)
  $$
  で更新したのち、正規化する。

- 占いクエリ
  $s = \sum_{v = 0, 1, \ldots} \mathrm{normpdf}(\mu, \sigma, v)$ とする。
  合計が $v$ である確率は、 $\frac{\mathrm{normpdf(\mu, \sigma, v)}}{s}$ みたいな気がする。
  厳密に更新しようとするとまずそう？　
  $0$ のやつについて占いをする前提... として、 $(1 - \frac{\mathrm{normpdf(\mu, \sigma, 0)}}{s})^x$ ここで、 $x$ はダブってる数
  を掛けたのち、正規化する... みたいな 

- 今まで壊れていた15, 19
  - 同じ形のピースが存在する！！！！！！！ だからsubmit一生されない
  - これ激ヤバですね　なるほど　同じ形があると壊れます
  - 今まで `oilfields: Vec<Vec<(usize, usize)>>` で管理していたが、
    `oilfields: Vec<(usize, Vec<(usize, usize)>)>` に変更する 一つ目がcount
  - それ以外ではまともな解答ができていそう

- $i, j$ が同じ形の時、$\forall dx, dy, P(i, dx, dy) = P(j, dx, dy)$ である
  - つまり、同じ位置にある！と推測されてしまう
  - これにより`ac_per`もなにもすべて壊れる

何とかする方針
  1. 個数を持つ
    更新が複雑になる
  1. acチェック時に同じ形があったらpの次に大きいやつを選ぶ
    更新今までと同じ
- 同じ形がある -> 確率は0.5に収束するだろ！と言い切る
  - 同じ個所にあると困るが、それより今のままはまずい
  - こうしてもac_perの計算がやばくない？うーん
  - 行けてそうな気もする　実装するか
  

例:
```
.#.
###
.#.
```
のピースが $4 \times 4$ の盤面上にあることを考える。ピース番号は省略する。

- 初期状態:
  - $P(0, 0) = \frac{1}{4}$
  - $P(0, 1) = \frac{1}{4}$
  - $P(1, 0) = \frac{1}{4}$
  - $P(1, 1) = \frac{1}{4}$
- クエリ: $(2, 2)$ が $1$ である
  - ステップ1: 更新:
    - $P(0, 0) \gets 0 \cdot \frac{1}{4} = 0$
    - $P(0, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 0) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
  - ステップ2: 正規化 
    - 総和は $\frac34$ なので、すべてに $\frac43$ を掛ける
    - $P(0, 0) \gets 0$
    - $P(0, 1) \gets \frac13$
    - $P(1, 0) \gets \frac13$
    - $P(1, 1) \gets \frac13$
- クエリ: $(1, 1)$ が $0$ である
　- ステップ1: 更新:
    - $P(0, 0) \gets 0 \cdot 0 = 0$
    - $P(0, 1) \gets 0 \cdot \frac13 = 0$
    - $P(1, 0) \gets 0 \cdot \frac13 = 0$
    - $P(1, 1) \gets 1 \cdot \frac13 = \frac13$
  - ステップ2: 正規化
    - 総和は $\frac13$ なので、すべてに $3$ を掛ける
    - $P(0, 0) \gets 0$
    - $P(0, 1) \gets 0$
    - $P(1, 0) \gets 0$
    - $P(1, 1) \gets 1$

- 初期状態
  - $P(0, 0) = \frac{1}{4}$
  - $P(0, 1) = \frac{1}{4}$
  - $P(1, 0) = \frac{1}{4}$
  - $P(1, 1) = \frac{1}{4}$
- クエリ: $(3, 3)$ が $1$ である
  - ステップ1: 更新:
    - $P(0, 0) \gets 0 \cdot \frac{1}{4} = 0$
    - $P(0, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 0) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
  - ステップ2: 正規化 
    - 総和は $\frac34$ なので、すべてに $\frac43$ を掛ける
    - $P(0, 0) \gets 0$
    - $P(0, 1) \gets \frac13$
    - $P(1, 0) \gets \frac13$
    - $P(1, 1) \gets \frac13$
- クエリ: $(2, 2)$ が $1$ である
  - ステップ1: 更新
    - $P(0, 0) \gets 1 \cdot 0 = 0$
    ...

これにより、単一ピースのクエリに対しては決定的に判定できる


例2:
```
.#.
###
.#.
```
```
..#.
####
```
の2つのピースが $4 \times 4$ の盤面上にあることを考える

答えとして、
```
0 0 1 0
0 1 2 1
2 2 2 1
0 0 0 0
```
ピース1は $(0, 1)$、ピース2は $(1, 0)$ にあるとき。

- 初期状態:
  - $P(1, 0, 0) = \frac{1}{4}$
  - $P(1, 0, 1) = \frac{1}{4}$
  - $P(1, 1, 0) = \frac{1}{4}$
  - $P(1, 1, 1) = \frac{1}{4}$
  - $P(2, 0, 0) = \frac{1}{3}$
  - $P(2, 1, 0) = \frac{1}{3}$
  - $P(2, 2, 0) = \frac{1}{3}$
- クエリ1: $(1, 1)$ が $1$
  - 2ピースのうち1つがある...
  - ピース1が $(1, 1)$ にある確率: $P(1, 0, 0) + P(1, 0, 1) + P(1, 1, 0) = \frac34$ 
    - 探索すればよい
  - ピース2が $(1, 1)$ にある確率: $P(2, 0, 0) = \frac13$

  - $P(1, 0, 0) \gets \frac23 * \frac14 = \frac16$
    - ピース1が $(0, 0)$ にあって、クエリが $(1, 1) = 1$ である確率
      - ピース1が $(0, 0)$ にあるとき、それのみで $(1, 1) = 1$ である
      - つまり、それ以外のピースが $(1, 1)$ にない確率に等しい
      - つまり、 $\frac23$
  - $P(1, 0, 1) \gets \frac23 * \frac14 = \frac16$
  - $P(1, 1, 0) \gets \frac23 * \frac14 = \frac16$
  - $P(1, 1, 1) \gets \frac13  * \frac14 = \frac1{12}$
    - ピース1が $(1, 1)$ にあって、クエリが $(1, 1) = 1$ である確率
      - それ以外のピースが $(1, 1)$ にある確率に等しい
      - つまり、 $\frac13$
  - $P(2, 0, 0) \gets \frac14 * \frac13 = \frac1{12}$
  - $P(2, 1, 0) \gets \frac34 * \frac13 = \frac14$
    - ピース2が $(1, 0)$ にあるとき、それ単体だと セル$(1, 1) = 0$ 
    - つまり、それ以外のピースが**1つ**、セル$(1, 1) に存在する必要がある
    - つまり、 $\frac34$ が必要
  - $P(2, 2, 0) \gets \frac34 * \frac13 = \frac14$
  - これらを正規化すると、
    - $P(1, 0, 0) = \frac27$
    - $P(1, 1, 0) = \frac27$
    - $P(1, 0, 1) = \frac27$
    - $P(1, 1, 1) = \frac17$
    - $P(2, 0, 0) = \frac17$
    - $P(2, 1, 0) = \frac37$
    - $P(2, 2, 0) = \frac37$
  





