# AHC030

$P((x, y), i) := $ $v(x, y) = i$ となる確率 とする
-> 座標に対して 0から20までのVec<f64>を持てばよい

占いで確定しているもの: i64 として持てばよい

これをベイズ推定でがんばる？


- 更新するとそれ以外のセルの更新が入る
  - 確定したときの更新

  - 推定したときの更新

...


- [ ] すべて確定させるやつを実装
- [ ] 色表示を実装、まだ見ていないやつを良しなにがんばる
  - 更新大変そう？うーん
- [ ] 推定する？

- ローカルのスコア 当てにならない(サイズ...)
  - なんかいい感じに調整しないとカス
- Rust サイコー！！
  - テストが途中で書ける


AtCoderにapprox入っていなくて切れた
https://atcoder.jp/contests/ahc030/submissions/50213595



### 1st submit 
9,147,000,000点 https://atcoder.jp/contests/ahc030/submissions/50213655
ランダム1点掘って推測 -> 答えが定まったらsubmit
```
50/50
total: 5800000000
max: (400000000, '0019')
ave: 116000000.0
min: (4000000, '0038')
```
TL 32msなので余裕

確率バグってる 既に検出済の期待値がおかしい
バグってすべてOPEN(つまり愚直)になっているのがある

---

油田 $i$ が $(dx, dy)$ にある確率を $P(i, dx, dy)$ と表す。

- つまり、任意の $i$ に対して、 $\sum_{dx \in X, dy \in Y} P(i, dx, dy) = 1$ である(ここで、$X, Y$ は可動範囲)
- 初期状態だと、$P(i, dx, dy) = \frac{1}{|X||Y|}$ みたいな値になる

これをベイズ更新することを考える。
クエリ結果を $q$ とすると、

$$
P(i, dx, dy) \gets P(i, dx, dy | q) = \frac{P(i, dx, dy) P(q | i, dx, dy)}{P(q)}
$$

で更新する。
ここで、尤度 $P(q | i, dx, dy)$ は、「ピース $i$ を $(dx, dy)$ に配置したときにクエリ結果 $q$ が返ってくる確率」である。

$P(q)$ を求めるのは面倒だが、更新後に \sum_{dx \in X, dy \in Y} P(i, dx, dy) = 1$ になるように丸めれば良いため、問題にならない。

以降、
$$
P(i, dx, dy) \gets P(i, dx, dy | q) = P(i, dx, dy) P(q | i, dx, dy)
$$
で更新したのち、正規化する。


例:
```
.#.
###
.#.
```
のピースが $4 \times 4$ の盤面上にあることを考える。ピース番号は省略する。

- 初期状態:
  - $P(0, 0) = \frac{1}{4}$
  - $P(0, 1) = \frac{1}{4}$
  - $P(1, 0) = \frac{1}{4}$
  - $P(1, 1) = \frac{1}{4}$
- クエリ: $(2, 2)$ が $1$ である
  - ステップ1: 更新:
    - $P(0, 0) \gets 0 \cdot \frac{1}{4} = 0$
    - $P(0, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 0) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
  - ステップ2: 正規化 
    - 総和は $\frac34$ なので、すべてに $\frac43$ を掛ける
    - $P(0, 0) \gets 0$
    - $P(0, 1) \gets \frac13$
    - $P(1, 0) \gets \frac13$
    - $P(1, 1) \gets \frac13$
- クエリ: $(1, 1)$ が $0$ である
　- ステップ1: 更新:
    - $P(0, 0) \gets 0 \cdot 0 = 0$
    - $P(0, 1) \gets 0 \cdot \frac13 = 0$
    - $P(1, 0) \gets 0 \cdot \frac13 = 0$
    - $P(1, 1) \gets 1 \cdot \frac13 = \frac13$
  - ステップ2: 正規化
    - 総和は $\frac13$ なので、すべてに $3$ を掛ける
    - $P(0, 0) \gets 0$
    - $P(0, 1) \gets 0$
    - $P(1, 0) \gets 0$
    - $P(1, 1) \gets 1$

- 初期状態
  - $P(0, 0) = \frac{1}{4}$
  - $P(0, 1) = \frac{1}{4}$
  - $P(1, 0) = \frac{1}{4}$
  - $P(1, 1) = \frac{1}{4}$
- クエリ: $(3, 3)$ が $1$ である
  - ステップ1: 更新:
    - $P(0, 0) \gets 0 \cdot \frac{1}{4} = 0$
    - $P(0, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 0) \gets 1 \cdot \frac{1}{4} = \frac14$
    - $P(1, 1) \gets 1 \cdot \frac{1}{4} = \frac14$
  - ステップ2: 正規化 
    - 総和は $\frac34$ なので、すべてに $\frac43$ を掛ける
    - $P(0, 0) \gets 0$
    - $P(0, 1) \gets \frac13$
    - $P(1, 0) \gets \frac13$
    - $P(1, 1) \gets \frac13$
- クエリ: $(2, 2)$ が $1$ である
  - ステップ1: 更新
    - $P(0, 0) \gets 1 \cdot 0 = 0$
    ...

これにより、単一ピースのクエリに対しては決定的に判定できる


例2:
```
.#.
###
.#.
```
```
..#.
####
```
の2つのピースが $4 \times 4$ の盤面上にあることを考える

答えとして、
```
0 0 1 0
0 1 2 1
2 2 2 1
0 0 0 0
```
ピース1は $(0, 1)$、ピース2は $(1, 0)$ にあるとき。

- 初期状態:
  - $P(1, 0, 0) = \frac{1}{4}$
  - $P(1, 0, 1) = \frac{1}{4}$
  - $P(1, 1, 0) = \frac{1}{4}$
  - $P(1, 1, 1) = \frac{1}{4}$
  - $P(2, 0, 0) = \frac{1}{3}$
  - $P(2, 1, 0) = \frac{1}{3}$
  - $P(2, 2, 0) = \frac{1}{3}$
- クエリ1: $(1, 1)$ が $1$
  - 2ピースのうち1つがある...
  - ピース1が $(1, 1)$ にある確率: $P(1, 0, 0) + P(1, 0, 1) + P(1, 1, 0) = \frac34$ 
    - 探索すればよい
  - ピース2が $(1, 1)$ にある確率: $P(2, 0, 0) = \frac13$

  - $P(1, 0, 0) \gets \frac23 * \frac14 = \frac16$
    - ピース1が $(0, 0)$ にあって、クエリが $(1, 1) = 1$ である確率
      - ピース1が $(0, 0)$ にあるとき、それのみで $(1, 1) = 1$ である
      - つまり、それ以外のピースが $(1, 1)$ にない確率に等しい
      - つまり、 $\frac23$
  - $P(1, 0, 1) \gets \frac23 * \frac14 = \frac16$
  - $P(1, 1, 0) \gets \frac23 * \frac14 = \frac16$
  - $P(1, 1, 1) \gets \frac13  * \frac14 = \frac1{12}$
    - ピース1が $(1, 1)$ にあって、クエリが $(1, 1) = 1$ である確率
      - それ以外のピースが $(1, 1)$ にある確率に等しい
      - つまり、 $\frac13$
  - $P(2, 0, 0) \gets \frac14 * \frac13 = \frac1{12}$
  - $P(2, 1, 0) \gets \frac34 * \frac13 = \frac14$
    - ピース2が $(1, 0)$ にあるとき、それ単体だと セル$(1, 1) = 0$ 
    - つまり、それ以外のピースが**1つ**、セル$(1, 1) に存在する必要がある
    - つまり、 $\frac34$ が必要
  - $P(2, 2, 0) \gets \frac34 * \frac13 = \frac14$
  - これらを正規化すると、
    - $P(1, 0, 0) = \frac27$
    - $P(1, 1, 0) = \frac27$
    - $P(1, 0, 1) = \frac27$
    - $P(1, 1, 1) = \frac17$
    - $P(2, 0, 0) = \frac17$
    - $P(2, 1, 0) = \frac37$
    - $P(2, 2, 0) = \frac37$
  




